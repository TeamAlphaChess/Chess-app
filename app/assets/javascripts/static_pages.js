$(document).ready(function() {
  var modalOpen = false;
  var currentOpenModal;
  var submissions = 0;
  // Deletes all input messages generated by ajax in form
  function deleteFormStatusText(modal) {
    var formInputMessages = modal.find('.form-item-error');
    var formFooterMessages = modal.find('.form-footer-status');
    var formFooterLinks = modal.find('.form-footer-link');
    var formInputs = modal.find('.form-inputs input');
    if (modalOpen === true) {
      formInputMessages.fadeOut('fast', function() {
        formInputMessages.remove();
      });

    } else {
      formInputMessages.removeClass('form-item-error');
      formInputMessages.remove();
      formFooterMessages.remove();
      formInputs.val('');
      formFooterLinks.fadeIn('fast');
    }
  }

  function openModal(modal) {
    currentOpenModal = modal;
    modal.modal({
      keyboard: false,
      backdrop: 'static'
    }).addClass('modal-flexbox');
    modalOpen = true;
    currentOpenModal = modal;
  }

  function closeModal(modal, callback = null) {
    modal.modal('hide');
    modalOpen = false;
    currentOpenModal = null;
    modal.on('hidden.bs.modal', function (e) {
      modal.removeClass('modal-flexbox');
      deleteFormStatusText(modal);
      submissions = 0;
      if (callback !== null && typeof callback === 'function') {
        callback();
      }
    });
  }

  $('.trigger-new-modal').on('click', function() {
    var newModal = $(this).data('modaltype') + 'Modal';
    if (modalOpen === true) {
      closeModal(currentOpenModal, function(){
        openModal($('#' + newModal));
      });
    }
  });

  $('.modal-trigger').on('click', function() {
    if (modalOpen === false) {
      var modal = $('#' + $(this).data('modaltype') + 'Modal' );
      openModal(modal);
    }
  });

  $('.modal-close').on('click', function() {
    if (modalOpen === true) {
      closeModal(currentOpenModal, null);
    }
  });

  $('form').submit(function() {
    var modal = $(this).parents('.modal');
    console.log($(this));

    if (modal.attr('id') === currentOpenModal.attr('id')) {
      if (submissions > 0) {
        deleteFormStatusText(modal);
      }

      $(this).bind("ajax:complete", function(event, response) {
        console.log($(this));

        var formFooterLinkContainer = modal.find('.form-footer-links-and-statuses')
        var formFooterLinks = formFooterLinkContainer.find('.form-footer-link');
        var responseText = response.responseJSON;

        if (response.redirect) {
          window.location.replace(this);

        } else if (response.status === 422) {
          var keyCapitalized;
          var errors = responseText.errors;
          for (var key in errors ) {
            keyCapitalized = key[0].toUpperCase() + key.substring(1, key.length);
            errorBox = currentOpenModal.find('[data-statusfor="' + key + '"]');
            errorBox.html('<li>' + keyCapitalized + ' ' + errors[key] + '</li>');
            errorBox.find('li').addClass('form-item-error').fadeIn('slow');
          }
        } else if (response.status === 401) {
          formFooterLinks.fadeOut('slow', function() {
            formFooterLinkContainer.append('<div>Wrong Email/Password</div>');
            var formFooterMessage = formFooterLinkContainer.find('div');
            formFooterMessage.addClass('form-footer-status form-item-error');
            formFooterMessage.fadeIn('slow').delay(1000).fadeOut('slow', function() {
              $(this).remove();
              formFooterLinks.fadeIn('slow');
            });
          });

        } else if (response.status === 201) {
          // Status 201 means success on POST, 200 is for GET
          formFooterLinks.fadeOut('slow', function() {
            formFooterLinkContainer.append('<div>Successful Submission</div>');
            var formFooterMessage = formFooterLinkContainer.find('div');
            formFooterMessage.addClass('form-footer-status form-item-successful');
            formFooterMessage.fadeIn('slow', function() {
              setTimeout(function() {
                closeModal(modal);
              }, 1000);
            });
          });
        }
      });
    }
    submissions += 1;
  });
});
